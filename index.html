<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>STB Diff Viewer</title>
    <link rel="stylesheet" href="./style/variables.css">
    <link rel="stylesheet" href="./style/style.css">
    <link rel="stylesheet" href="./style/utilities.css">
    <link rel="stylesheet" href="./style/components/floating.css">
    <link rel="stylesheet" href="./style/components/accordion.css">
    <link rel="stylesheet" href="./style/components/buttons.css">
    <link rel="stylesheet" href="./style/components/tree.css">
    <link rel="stylesheet" href="./style/components/forms.css">
    <link rel="stylesheet" href="./style/components/panels.css">
    <link rel="stylesheet" href="./style/components/color-modes.css">
    <link rel="stylesheet" href="./style/components/diff.css">
    <link rel="stylesheet" href="./style/components/clipping.css">
    <link rel="stylesheet" href="./style/components/comparison.css">
    <link rel="stylesheet" href="./style/components/importance.css">
    <link rel="stylesheet" href="./style/components/dxf.css">
    <link rel="stylesheet" href="./style/components/diffList.css">
    <link rel="stylesheet" href="./style/components/theme.css">
    <link rel="stylesheet" href="./style/components/toast.css">
    <!-- Import map for bare module specifiers used in ES modules (browser) -->
    <script type="importmap">
      {
        "imports": {
          "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
          "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/",
          "camera-controls": "https://unpkg.com/camera-controls@3.1.0/dist/camera-controls.module.js"
        }
      }
    </script>
    <!-- DXF Parser Library -->
    <script src="https://cdn.jsdelivr.net/npm/dxf-parser@1.1.2/dist/dxf-parser.min.js"></script>
  </head>
  <body>
    <div id="overlay">
      <!-- モデル読み込みと比較セクション -->
      <div class="accordion-section">
        <div class="accordion-header" data-target="file-loading" role="button" tabindex="0" aria-controls="file-loading" aria-expanded="true">
          <span>📊 モデル読み込みと比較</span>
          <span class="accordion-arrow">▼</span>
        </div>
        <div class="accordion-content" id="file-loading" aria-hidden="false">
          <div class="diff-comparison-intro">
            <p>2つのSTBモデルを比較して差分を確認します</p>
          </div>
          <div class="file-input-wrapper">
            <label for="fileA"><strong>比較元モデル (A)</strong></label>
            <button type="button" class="custom-file-btn" data-target="fileA">
              ファイルを選択
            </button>
            <input type="file" id="fileA" accept=".stb,.xml">
            <div class="selected-filename" id="fileA-name">
              選択されていません
            </div>
          </div>

          <div class="file-input-wrapper">
            <label for="fileB"><strong>比較先モデル (B)</strong></label>
            <button type="button" class="custom-file-btn" data-target="fileB">
              ファイルを選択
            </button>
            <input type="file" id="fileB" accept=".stb,.xml">
            <div class="selected-filename" id="fileB-name">
              選択されていません
            </div>
          </div>

          <hr class="section-divider">

          <button type="button" id="compareButton" class="btn-primary compare-button">
            🔍 STB読込
          </button>

          <!-- 差分結果サマリー表示エリア -->
          <div id="diff-summary" class="hidden">
            <div class="diff-summary-title">📈 差分サマリー</div>
            <div id="diff-summary-content">
              <!-- 動的に生成される差分統計 -->
            </div>
          </div>
        </div>
      </div>

      <!-- 表示設定セクションをモデル読み込みの下に移動（初期開いた状態） -->
      <div class="accordion-section">
        <div class="accordion-header" data-target="display-group-settings" role="button" tabindex="0" aria-controls="display-group-settings" aria-expanded="true">
          <span>👁️ 表示設定</span>
          <span class="accordion-arrow">▼</span>
        </div>
        <div class="accordion-content" id="display-group-settings" aria-hidden="false">
          <!-- 表示要素設定セクション -->
          <button type="button" id="toggle-element-settings-btn" aria-controls="element-settings-float" aria-expanded="false">🏗️ 表示要素設定</button>

          <!-- 表示範囲設定セクション -->
          <button type="button" id="toggle-clipping-settings-btn" aria-controls="clipping-settings-float" aria-expanded="false">✂️ 表示範囲設定</button>

          <!-- 表示モード設定セクション -->
          <button type="button" id="toggle-camera-settings-btn" aria-controls="camera-settings-float" aria-expanded="false">🔄 表示モード設定</button>
        </div>
      </div>

      <!-- 色付けモード設定セクション -->
      <button type="button" id="toggle-display-settings-btn" aria-controls="display-settings-float" aria-expanded="false">🎨 色付けモード設定</button>

      <!-- 許容差設定セクション -->
      <button type="button" id="toggle-tolerance-settings-btn" aria-controls="tolerance-settings-float" aria-expanded="false">⚙️ 許容差設定</button>


      <!-- 要素情報パネル -->
      <button type="button" id="toggle-component-info-btn" aria-controls="component-info" aria-expanded="false">📋 要素情報パネル</button>

      <!-- ツリービュー（要素・断面統合） -->
      <button type="button" id="toggle-tree-view-btn">🌳 ツリービュー</button>

      <!-- 重要度設定セクション -->
      <div class="accordion-section">
        <div class="accordion-header" data-target="importance-settings" role="button" tabindex="0" aria-controls="importance-settings" aria-expanded="false">
          <span>🏷️ 重要度設定</span>
          <span class="accordion-arrow">▼</span>
        </div>
        <div class="accordion-content collapsed" id="importance-settings" aria-hidden="true">
          <button type="button" id="toggleImportanceBtn" class="btn btn-primary">
            🏷️ 重要度パネル表示
          </button>
          <button type="button"
            onclick="window.toggleImportanceStatistics()"
            class="btn btn-primary"
          >
            📊 統計表示
          </button>
          <button type="button"
            onclick="window.toggleBulkOperations()"
            class="btn btn-primary"
          >
            ⚙️ 一括操作
          </button>
        </div>
      </div>
      <!-- DXF CAD はフローティングウィンドウへ移設しました -->
      <div class="accordion-section">
        <div class="accordion-header" data-target="dxf-loading" role="button" tabindex="0" aria-controls="dxf-loading" aria-expanded="false">
          <span>📐 DXF CADデータ読み込み</span>
          <span class="accordion-arrow">▼</span>
        </div>
        <div class="accordion-content collapsed" id="dxf-loading" aria-hidden="true">
          <p>詳細設定はフローティングウィンドウで行います。</p>
          <button type="button" id="toggle-dxf-floating-btn" class="btn-primary">DXFパネルを開く</button>
        </div>
      </div>

      <!-- その他設定セクション -->
      <div class="accordion-section">
        <div class="accordion-header" data-target="other-settings" role="button" tabindex="0" aria-controls="other-settings" aria-expanded="false">
          <span>⚙️ その他設定</span>
          <span class="accordion-arrow">▼</span>
        </div>
        <div class="accordion-content collapsed" id="other-settings" aria-hidden="true">
          <!-- テーマ切り替え -->
          <div class="theme-settings">
            <span class="theme-settings-label">テーマ:</span>
            <div class="theme-button-group" id="theme-button-group">
              <button type="button" data-theme="light" class="active">ライト</button>
              <button type="button" data-theme="dark">ダーク</button>
              <button type="button" data-theme="system">自動</button>
            </div>
          </div>

          <button type="button" id="toggleLegendBtn" class="btn btn-primary">
            🔍 差分凡例・操作方法を表示
          </button>

          <!-- IFC出力ボタン -->
          <button type="button" id="exportIfcBtn" class="btn btn-secondary">
            📦 IFCファイルに変換 (WIP)
          </button>

          <!-- CORS問題対応セクション -->
          <div id="cors-warning" class="cors-warning">
            <div class="warning-title">⚠️ IFC変換API接続問題</div>
            <p>Google Cloud RunのAPIサーバーでCORS設定に問題があります。</p>
            <div class="cors-solutions">
              <strong>解決方法:</strong>
              <ol>
                <li>ブラウザのCORS制限を無効化（開発者向け）</li>
                <li>ローカルプロキシサーバーの使用</li>
                <li>
                  <span
                    class="cors-link"
                    onclick="window.open('https://cors-anywhere.herokuapp.com/corsdemo')"
                    >CORS Anywhere デモ</span
                  >を有効化
                </li>
                <li>サーバー管理者にCORS設定の修正を依頼</li>
              </ol>
              <button type="button"
                id="try-cors-proxy"
                class="btn btn-warning"
                onclick="window.enableCorsProxy()"
              >
                CORS プロキシを試行
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // ファイル選択のカスタムボタン挙動を設定
      (function () {
        function wire(targetId) {
          var btn = document.querySelector(
            '.custom-file-btn[data-target="' + targetId + '"]'
          );
          var input = document.getElementById(targetId);
          var nameEl = document.getElementById(targetId + "-name");
          if (!btn || !input || !nameEl) return;
          btn.addEventListener("click", function () {
            input.click();
          });
          input.addEventListener("change", function (e) {
            var f = input.files && input.files[0];
            nameEl.textContent = f ? f.name : "選択されていません";
          });
        }

        function wireAll() {
          wire("fileA");
          wire("fileB");
          wire("dxfFile");
        }

        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', wireAll);
        } else {
          wireAll();
        }
      })();
    </script>

    <!-- ここに凡例パネルのHTMLを追加 -->
    <div id="legendPanel" class="panel legend-panel-hidden">
      <!-- 初期状態は非表示 -->
      <div class="panel-header">🔍 差分比較凡例</div>
      <div class="legend-content">
        <div class="legend-item">
          <span class="legend-color legend-color-matched"></span>
          <span><strong>一致要素</strong></span>
        </div>
        <div class="legend-item">
          <span class="legend-color legend-color-onlya"></span>
          <span><strong>モデルA専用</strong></span>
        </div>
        <div class="legend-item">
          <span class="legend-color legend-color-onlyb"></span>
          <span><strong>モデルB専用</strong></span>
        </div>
        <hr >
        <div class="legend-item">
          <span class="legend-description">
            色分けで差分を直感的に確認できます
          </span>
        </div>
        <hr >
        <div class="legend-item">
          <span><b>操作方法:</b></span>
        </div>
        <div class="legend-item">
          <span>回転: 左ドラッグ</span>
        </div>
        <div class="legend-item">
          <span>平行移動: 右ドラッグ</span>
        </div>
        <div class="legend-item">
          <span>ズーム: ホイール</span>
        </div>
      </div>
    </div>
    <!-- /凡例パネル -->

    <!-- ★★★ 追加: 要素情報表示パネル ★★★ -->
    <div id="component-info" class="floating-window component-info-resizable">
      <div class="float-window-header" id="component-info-header">
        <span class="float-window-title">📋 要素情報</span>
        <div class="float-window-controls">
          <button class="float-window-btn" id="close-component-info-btn" aria-label="閉じる" type="button">
            ✕
          </button>
        </div>
      </div>

      <div class="float-window-content" id="component-info-content-wrapper">
        <!-- 編集機能UI (最小化) -->
        <div id="editing-controls" class="editing-controls-muted">
          <button
            id="edit-mode-button"
            class="btn btn-sm"
            onclick="window.toggleEditMode()"
            title="高度な編集機能（開発者向け)"
           type="button">
            編集
          </button>
          <span id="editing-summary" class="editing-summary-text">
            修正: 0件
          </span>
        </div>
        <div id="element-info-content">要素を選択してください。</div>
      </div>
    </div>
    <!-- /要素情報表示パネル -->

    <canvas id="three-canvas"></canvas>

    <!-- 環境設定管理 -->
    <script type="module">
      import {
        getEnvironmentConfig,
        isFeatureEnabled,
        displayEnvironmentInfo,
      } from "./js/config/environment.js";

      // 環境設定を非同期で初期化
      async function initializeEnvironment() {
        try {
          window.envConfig = await getEnvironmentConfig();

          // 開発環境でのみテストリンクとデバッグ情報を表示
          if (window.envConfig.features.devTools) {
            const devToolsEl = document.getElementById("dev-tools");
            if (devToolsEl) {
              devToolsEl.style.display = "block";
            }
            await displayEnvironmentInfo();
          }

          // 統一ロガーが読み込まれる前でも安全なように try/catch
          try {
            window.AppLogger?.setLevel &&
              window.AppLogger.setLevel(window.envConfig?.logLevel || "warn");
          } catch (e) {}
          console.log("✅ 環境設定初期化完了:", window.envConfig.environment);
        } catch (error) {
          console.error("❌ 環境設定初期化エラー:", error);
          // フォールバック設定
          window.envConfig = {
            environment: "production",
            stb2ifc: {
              apiBaseUrl: "https://stb2ifc-api-e23mdd6kwq-an.a.run.app",
            },
            features: { devTools: false },
          };
        }
      }

      // CORS プロキシ有効化関数（環境設定を使用）
      window.enableCorsProxy = async function () {
        if (window.ifcConverter) {
          try {
            if (!window.envConfig) {
              window.envConfig = await getEnvironmentConfig();
            }

            const originalUrl = window.ifcConverter.apiBaseUrl;
            window.ifcConverter.apiBaseUrl =
              window.envConfig.corsProxy.proxyUrl +
              window.envConfig.stb2ifc.apiBaseUrl;

            alert(
              `CORS プロキシが有効化されました。\n\n新しいURL: ${window.ifcConverter.apiBaseUrl}\n\n注意: このサービスは実験的で、本番使用は推奨されません。`
            );

            // 警告を非表示
            if (window.ifcConverter.hideCorsWarning) {
              window.ifcConverter.hideCorsWarning();
            }
          } catch (error) {
            console.error("CORS プロキシ設定エラー:", error);
            alert("CORS プロキシの設定に失敗しました。");
          }
        }
      };

      // グローバルに非同期版関数を公開
      window.isFeatureEnabled = isFeatureEnabled;
      window.getEnvironmentConfig = getEnvironmentConfig;

      // ページロード時に初期化
      initializeEnvironment();
    </script>

    <!-- ★★★ パスを js/main.js に変更 ★★★ -->
    <script type="module" src="js/main.js"></script>

    <!-- 開発用: 断面差異診断ユーティリティ -->
    <script type="module" src="js/diagnostics/geometryInspector.js"></script>
    <script
      type="module"
      src="js/diagnostics/geometryMismatchAnalyzer.js"
    ></script>

    <!-- ★★★ 追加: selectComponentInfo.js の script タグは不要 (main.js から import されるため) ★★★ -->
    <!-- <script type="module" stb-diff-viewer="selectComponentInfo.js"></script> -->

    <!-- 表示要素設定フローティングウィンドウ -->
    <div id="element-settings-float" class="floating-window">
      <div class="float-window-header" id="element-settings-header">
        <span class="float-window-title">🏗️ 表示要素設定</span>
        <div class="float-window-controls">
          <button class="float-window-btn" id="close-element-settings-btn" aria-label="閉じる" type="button">
            ✕
          </button>
        </div>
      </div>
      <div class="float-window-content">
        <div id="elementSelector">
          <label><strong>モデル表示</strong></label>
          <label>
            <input type="checkbox"
              id="toggleModelA"
              name="modelVisibility"
              value="A"
              checked
            >
            モデルAを表示
          </label>
          <br>
          <label>
            <input type="checkbox"
              id="toggleModelB"
              name="modelVisibility"
              value="B"
              checked
            >
            モデルBを表示
          </label>

          <hr class="section-divider" >

          <!-- ラベル表示内容設定 -->
          <label><strong>ラベル表示内容</strong></label>
          <select
            id="labelContentSelector"
            class="form-control mb-2"
            title="ラベルに表示する内容を選択"
          >
            <option value="id">タグ（デフォルト）</option>
            <option value="name">インスタンス名（Name）</option>
            <option value="section">断面名（Section）</option>
          </select>

          <hr class="section-divider" >

          <label><strong>比較/表示する要素</strong></label>
          <table class="element-settings-table">
            <thead>
              <tr>
                <th>要素</th>
                <th>表示</th>
                <th>立体</th>
                <th>ラベル</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>節点 (StbNode)</td>
                <td><input type="checkbox" name="elements" value="Node" id="toggleNodeView" title="節点を表示" checked></td>
                <td>-</td>
                <td><input type="checkbox" name="labelToggle" value="Node" id="toggleLabel-Node" title="節点ラベルを表示"></td>
              </tr>
              <tr>
                <td>通り芯 (StbAxis)</td>
                <td><input type="checkbox" name="elements" value="Axis" id="toggleAxisView" title="通り芯を表示" checked></td>
                <td>-</td>
                <td><input type="checkbox" name="labelToggle" value="Axis" id="toggleLabel-Axis" title="通り芯ラベルを表示" checked></td>
              </tr>
              <tr>
                <td>階 (StbStory)</td>
                <td><input type="checkbox" name="elements" value="Story" id="toggleStoryView" title="階を表示" checked></td>
                <td>-</td>
                <td><input type="checkbox" name="labelToggle" value="Story" id="toggleLabel-Story" title="階ラベルを表示" checked></td>
              </tr>
              <tr>
                <td>柱 (StbColumn)</td>
                <td><input type="checkbox" name="elements" value="Column" title="柱を表示" checked></td>
                <td><input type="checkbox" id="toggleColumnView" name="columnViewMode" title="柱を立体表示" checked></td>
                <td><input type="checkbox" name="labelToggle" value="Column" id="toggleLabel-Column" title="柱ラベルを表示"></td>
              </tr>
              <tr>
                <td>大梁 (StbGirder)</td>
                <td><input type="checkbox" name="elements" value="Girder" title="大梁を表示" checked></td>
                <td><input type="checkbox" id="toggleGirderView" name="girderViewMode" title="大梁を立体表示" checked></td>
                <td><input type="checkbox" name="labelToggle" value="Girder" id="toggleLabel-Girder" title="大梁ラベルを表示"></td>
              </tr>
              <tr>
                <td>小梁 (StbBeam)</td>
                <td><input type="checkbox" name="elements" value="Beam" title="小梁を表示" checked></td>
                <td><input type="checkbox" id="toggleBeam3DView" name="beam3DViewMode" title="小梁を立体表示" checked></td>
                <td><input type="checkbox" name="labelToggle" value="Beam" id="toggleLabel-Beam" title="小梁ラベルを表示"></td>
              </tr>
              <tr>
                <td>ブレース (StbBrace)</td>
                <td><input type="checkbox" name="elements" value="Brace" id="toggleBraceView" title="ブレースを表示" checked></td>
                <td><input type="checkbox" id="toggleBrace3DView" name="brace3DViewMode" title="ブレースを立体表示" checked></td>
                <td><input type="checkbox" name="labelToggle" value="Brace" id="toggleLabel-Brace" title="ブレースラベルを表示"></td>
              </tr>
              <tr>
                <td>間柱 (StbPost)</td>
                <td><input type="checkbox" name="elements" value="Post" id="togglePostView" title="間柱を表示" checked></td>
                <td><input type="checkbox" id="togglePost3DView" name="post3DViewMode" title="間柱を立体表示" checked></td>
                <td><input type="checkbox" name="labelToggle" value="Post" id="toggleLabel-Post" title="間柱ラベルを表示"></td>
              </tr>
              <tr>
                <td>スラブ (StbSlab)</td>
                <td><input type="checkbox" name="elements" value="Slab" id="toggleSlabView" title="スラブを表示" checked></td>
                <td><input type="checkbox" id="toggleSlab3DView" name="slab3DViewMode" title="スラブを立体表示" checked></td>
                <td><input type="checkbox" name="labelToggle" value="Slab" id="toggleLabel-Slab" title="スラブラベルを表示"></td>
              </tr>
              <tr>
                <td>壁 (StbWall)</td>
                <td><input type="checkbox" name="elements" value="Wall" id="toggleWallView" title="壁を表示" checked></td>
                <td><input type="checkbox" id="toggleWall3DView" name="wall3DViewMode" title="壁を立体表示" checked></td>
                <td><input type="checkbox" name="labelToggle" value="Wall" id="toggleLabel-Wall" title="壁ラベルを表示"></td>
              </tr>
              <tr>
                <td>杭 (StbPile)</td>
                <td><input type="checkbox" name="elements" value="Pile" id="togglePileView" title="杭を表示" checked></td>
                <td><input type="checkbox" id="togglePile3DView" name="pile3DViewMode" title="杭を立体表示" checked></td>
                <td><input type="checkbox" name="labelToggle" value="Pile" id="toggleLabel-Pile" title="杭ラベルを表示"></td>
              </tr>
              <tr>
                <td>基礎 (StbFooting)</td>
                <td><input type="checkbox" name="elements" value="Footing" id="toggleFootingView" title="基礎を表示" checked></td>
                <td><input type="checkbox" id="toggleFooting3DView" name="footing3DViewMode" title="基礎を立体表示" checked></td>
                <td><input type="checkbox" name="labelToggle" value="Footing" id="toggleLabel-Footing" title="基礎ラベルを表示"></td>
              </tr>
              <tr>
                <td>基礎柱 (StbFoundationColumn)</td>
                <td><input type="checkbox" name="elements" value="FoundationColumn" id="toggleFoundationColumnView" title="基礎柱を表示" checked></td>
                <td><input type="checkbox" id="toggleFoundationColumn3DView" name="foundationColumn3DViewMode" title="基礎柱を立体表示" checked></td>
                <td><input type="checkbox" name="labelToggle" value="FoundationColumn" id="toggleLabel-FoundationColumn" title="基礎柱ラベルを表示"></td>
              </tr>
            </tbody>
          </table>

          <!-- 配置基準線表示切り替え -->
          <div class="placement-line-control">
            <label for="togglePlacementLines">
              <input type="checkbox" id="togglePlacementLines" checked>
              立体表示時の配置基準線を表示
            </label>
          </div>
        </div>
      </div>
    </div>

    <!-- 許容差設定ウィンドウはWindowManagerで動的生成します -->

    <!-- DXF フローティングウィンドウ -->
    <div id="dxf-floating" class="floating-window">
      <div class="float-window-header" id="dxf-floating-header">
        <span class="float-window-title">📐 DXF CADデータ</span>
        <div class="float-window-controls">
          <button class="float-window-btn" id="close-dxf-floating-btn" aria-label="閉じる" type="button">✕</button>
        </div>
      </div>

      <div class="float-window-content">
        <div class="dxf-intro">
          <p>DXFファイルを読み込んで2D/3D表示します</p>
        </div>
        <div class="file-input-wrapper">
          <label for="dxfFile"><strong>DXFファイル</strong></label>
          <button type="button" class="custom-file-btn" data-target="dxfFile">ファイルを選択</button>
          <input type="file" id="dxfFile" accept=".dxf">
          <div class="selected-filename" id="dxfFile-name">選択されていません</div>
        </div>

        <hr class="section-divider">

        <div id="dxf-placement-options" class="dxf-placement-options">
          <label><strong>配置設定</strong></label>

          <div class="dxf-placement-plane">
            <label for="dxfPlacementPlane">配置面:</label>
            <select id="dxfPlacementPlane">
              <option value="xy">XY平面 (平面図 → 階に配置)</option>
              <option value="xz">XZ平面 (Y通り断面図)</option>
              <option value="yz">YZ平面 (X通り断面図)</option>
            </select>
          </div>

          <div class="dxf-placement-position">
            <label for="dxfPlacementPosition">配置位置:</label>
            <select id="dxfPlacementPosition">
              <option value="origin">原点 (0)</option>
            </select>
          </div>

          <div class="dxf-placement-offset">
            <label>
              <input type="checkbox" id="dxfManualOffset"> 手動オフセット指定
            </label>
            <div id="dxf-manual-offset-inputs" class="hidden">
              <div class="offset-input-row">
                <label for="dxfOffsetX">X:</label>
                <input type="number" id="dxfOffsetX" value="0" step="100"><span>mm</span>
              </div>
              <div class="offset-input-row">
                <label for="dxfOffsetY">Y:</label>
                <input type="number" id="dxfOffsetY" value="0" step="100"><span>mm</span>
              </div>
              <div class="offset-input-row">
                <label for="dxfOffsetZ">Z:</label>
                <input type="number" id="dxfOffsetZ" value="0" step="100"><span>mm</span>
              </div>
            </div>
          </div>
        </div>

        <hr class="section-divider">

        <div class="dxf-buttons">
          <button type="button" id="loadDxfButton" class="btn-primary">📐 DXF読込</button>
          <button type="button" id="toggleDxfEditMode" class="btn-secondary">位置調整モード開始</button>
          <button type="button" id="clearDxfButton" class="btn-secondary">クリア</button>
        </div>

        <div id="dxf-summary" class="hidden"></div>

        <div id="dxf-layer-panel" class="hidden">
          <hr class="section-divider">
          <label><strong>レイヤー表示設定</strong></label>
          <div id="dxf-layer-list" class="dxf-layer-list"></div>
        </div>

        <div id="dxf-export-panel" class="hidden">
          <hr class="section-divider">
          <label><strong>DXFエクスポート</strong></label>
          <div class="dxf-export-intro">
            <p>選択したレイヤーを2D CADデータとしてエクスポートします</p>
          </div>
          <div class="dxf-export-layer-select">
            <div class="dxf-export-layer-header">
              <span>エクスポートするレイヤー:</span>
              <div class="dxf-export-layer-actions">
                <button type="button" id="selectAllExportLayers" class="btn-link">全選択</button>
                <span class="separator">|</span>
                <button type="button" id="deselectAllExportLayers" class="btn-link">全解除</button>
              </div>
            </div>
            <div id="dxf-export-layer-list" class="dxf-export-layer-list"></div>
          </div>
          <div id="dxf-export-stats" class="dxf-export-stats"><span id="export-entity-count">選択: 0 要素</span></div>
          <div class="dxf-export-filename"><label for="dxfExportFilename">ファイル名:</label><input type="text" id="dxfExportFilename" placeholder="export" value="export"></div>
          <button type="button" id="exportDxfButton" class="btn-primary dxf-export-btn">DXFエクスポート</button>
        </div>

        <div id="stb-dxf-export-panel" class="hidden">
          <hr class="section-divider">
          <label><strong>STB→DXFエクスポート</strong></label>
          <div class="dxf-export-intro">
            <p>立体表示中の部材を2D CADデータとしてエクスポートします</p>
            <p class="stb-export-note">※ 2Dモード + 立体表示オンの場合のみ使用可能</p>
          </div>
          <div id="stb-export-status" class="stb-export-status"><span id="stb-export-status-text">状態を確認中...</span></div>
          <div id="stb-export-element-select" class="dxf-export-layer-select hidden">
            <div class="dxf-export-layer-header">
              <span>エクスポートする部材:</span>
              <div class="dxf-export-layer-actions">
                <button type="button" id="selectAllStbExportTypes" class="btn-link">全選択</button>
                <span class="separator">|</span>
                <button type="button" id="deselectAllStbExportTypes" class="btn-link">全解除</button>
              </div>
            </div>
            <div id="stb-export-type-list" class="dxf-export-layer-list"></div>
          </div>
          <div id="stb-export-stats" class="dxf-export-stats hidden"><span id="stb-export-mesh-count">選択: 0 メッシュ</span></div>
          <div id="stb-export-filename-group" class="dxf-export-filename hidden"><label for="stbDxfExportFilename">ファイル名:</label><input type="text" id="stbDxfExportFilename" placeholder="stb_export" value="stb_export"></div>
          <button type="button" id="exportStbDxfButton" class="btn-primary dxf-export-btn" disabled>STB→DXFエクスポート</button>
        </div>
      </div>
    </div>

    <!-- 表示モード設定フローティングウィンドウ -->
    <div id="display-settings-float" class="floating-window">
      <div class="float-window-header" id="display-settings-header">
        <span class="float-window-title">🎨 色付けモード設定</span>
        <div class="float-window-controls">
          <button class="float-window-btn" id="close-display-settings-btn" aria-label="閉じる" type="button">
            ✕
          </button>
        </div>
      </div>
      <div class="float-window-content">
        <!-- 色付けモード選択UI -->
        <div id="color-mode-controls">
          <label><strong>表示モード</strong></label>
          <div class="diff-mode-description">
            差分確認には「差分表示」を推奨します
          </div>
          <select
            id="colorModeSelector"
            class="form-control"
            title="色付けモードを選択"
          >
            <option value="diff">🔍 差分表示（推奨）</option>
            <option value="element">🏗️ 部材別色付け</option>
            <option value="schema">⚠️ スキーマエラー表示</option>
            <option value="importance">🏷️ 重要度別色付け</option>
          </select>

          <div id="comparison-key-settings" class="comparison-key-settings">
            <hr class="settings-separator" >
            <div id="comparison-key-selector-container">
              <!-- comparisonKeySelector.jsによって動的に生成される -->
            </div>
          </div>

          <!-- 色付けモード状況メッセージ -->
          <div id="color-mode-status" class="color-mode-status hidden">
            <span id="color-mode-status-text"></span>
          </div>

          <!-- 部材別色付け設定 -->
          <div id="element-color-settings" class="element-color-settings">
            <label class="color-setting-label">部材色設定:</label>
            <div class="color-setting-help">
              ※ 色ボックスをクリックして各部材の表示色を変更できます
            </div>
            <div class="color-legend-container" id="element-color-controls">
              <!-- 動的に生成される -->
            </div>
          </div>

          <!-- スキーマエラー色設定 -->
          <div id="schema-color-settings" class="schema-color-settings">
            <label class="color-setting-label">スキーマエラー色設定:</label>
            <div class="color-setting-help">
              ※ スキーマ検証の結果に応じて要素に色付けします
            </div>
            <div class="color-legend-container">
              <div class="legend-item">
                <input type="color"
                  id="schema-valid-color"
                  value="#00aaff"
                  class="legend-color-box"
                  title="正常要素の色を変更"
                >
                <span class="legend-label">正常要素</span>
                <span
                  class="color-preview"
                  id="schema-valid-preview"
                  title="現在の色: #00aaff"
                ></span>
                <span id="schema-valid-count" class="legend-count badge badge-valid"></span>
              </div>
              <div class="legend-item">
                <input
                  type="color"
                  id="schema-info-color"
                  value="#32CD32"
                  class="legend-color-box"
                  title="自動修復可能要素の色を変更"
                />
                <span class="legend-label">自動修復</span>
                <span
                  class="color-preview"
                  id="schema-info-preview"
                  title="現在の色: #32CD32"
                ></span>
                <span id="schema-info-count" class="legend-count badge badge-info"></span>
              </div>
              <div class="legend-item">
                <input
                  type="color"
                  id="schema-warning-color"
                  value="#FFA500"
                  class="legend-color-box"
                  title="要確認要素の色を変更"
                />
                <span class="legend-label">要確認</span>
                <span
                  class="color-preview"
                  id="schema-warning-preview"
                  title="現在の色: #FFA500"
                ></span>
                <span id="schema-warning-count" class="legend-count badge badge-warning"></span>
              </div>
              <div class="legend-item">
                <input type="color"
                  id="schema-error-color"
                  value="#ff0000"
                  class="legend-color-box"
                  title="エラー要素の色を変更"
                />
                <span class="legend-label">手動修正</span>
                <span
                  class="color-preview"
                  id="schema-error-preview"
                  title="現在の色: #ff0000"
                ></span>
                <span id="schema-error-count" class="legend-count badge badge-error"></span>
              </div>
            </div>
          </div>

          <!-- 重要度色設定 -->
          <div id="importance-color-settings" class="importance-color-settings">
            <label class="color-setting-label">重要度色設定:</label>
            <div class="color-setting-help">
              ※ 各重要度レベルの表示色を変更できます
            </div>
            <div class="color-legend-container" id="importance-color-controls">
              <!-- 動的に生成される -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 表示範囲設定フローティングウィンドウ -->
    <div id="clipping-settings-float" class="floating-window">
      <div class="float-window-header" id="clipping-settings-header">
        <span class="float-window-title">✂️ 表示範囲設定</span>
        <div class="float-window-controls">
          <button class="float-window-btn" id="close-clipping-settings-btn" aria-label="閉じる" type="button">
            ✕
          </button>
        </div>
      </div>
      <div class="float-window-content">
        <!-- 階クリッピング設定 -->
        <div class="clipping-group">
          <label for="storySelector"><strong>階の表示制限</strong></label>
          <select id="storySelector"></select>
          <button id="applyStoryClipButton" class="clip-apply-btn" type="button">
            この階でクリップ
          </button>

          <!-- 階クリッピング範囲調整 -->
          <div id="storyClipControls" class="clip-range-controls hidden">
            <div class="range-control-group">
              <label for="storyClipRange">クリッピング範囲:</label>
              <div class="range-slider-container">
                <span class="range-label">狭い</span>
                <input type="range"
                  id="storyClipRange"
                  min="500"
                  max="5000"
                  value="1000"
                  step="100"
                  class="clip-range-slider"
                >
                <span class="range-label">広い</span>
              </div>
              <div class="range-value-display">
                ±<span id="storyRangeValue">1.0</span>m
              </div>
            </div>
          </div>
        </div>

        <hr class="section-divider" >

        <!-- X軸クリッピング設定 -->
        <div class="clipping-group">
          <label for="xAxisSelector"><strong>X軸選択</strong></label>
          <select id="xAxisSelector"></select>
          <button id="applyXAxisClipButton" class="clip-apply-btn" type="button">
            X軸でクリップ
          </button>

          <!-- X軸クリッピング範囲調整 -->
          <div id="xAxisClipControls" class="clip-range-controls hidden">
            <div class="range-control-group">
              <label for="xAxisClipRange">クリッピング範囲:</label>
              <div class="range-slider-container">
                <span class="range-label">狭い</span>
                <input type="range"
                  id="xAxisClipRange"
                  min="500"
                  max="10000"
                  value="2000"
                  step="250"
                  class="clip-range-slider"
                >
                <span class="range-label">広い</span>
              </div>
              <div class="range-value-display">
                ±<span id="xAxisRangeValue">2.0</span>m
              </div>
            </div>
          </div>
        </div>

        <hr class="section-divider" >

        <!-- Y軸クリッピング設定 -->
        <div class="clipping-group">
          <label for="yAxisSelector"><strong>Y軸選択</strong></label>
          <select id="yAxisSelector"></select>
          <button id="applyYAxisClipButton" class="clip-apply-btn" type="button">
            Y軸でクリップ
          </button>

          <!-- Y軸クリッピング範囲調整 -->
          <div id="yAxisClipControls" class="clip-range-controls hidden">
            <div class="range-control-group">
              <label for="yAxisClipRange">クリッピング範囲:</label>
              <div class="range-slider-container">
                <span class="range-label">狭い</span>
                <input type="range"
                  id="yAxisClipRange"
                  min="500"
                  max="10000"
                  value="2000"
                  step="250"
                  class="clip-range-slider"
                >
                <span class="range-label">広い</span>
              </div>
              <div class="range-value-display">
                ±<span id="yAxisRangeValue">2.0</span>m
              </div>
            </div>
          </div>
        </div>

        <hr class="section-divider" >

        <!-- 2D奥行きクリッピング設定 -->
        <div class="clipping-group hidden" id="depth2DClippingGroup">
          <label><strong>2D表示奥行き範囲</strong></label>
          <p class="help-text">
            2Dビュー時に表示する奥行き（Z軸）範囲を調整します
          </p>

          <!-- 奥行きクリッピング範囲調整 -->
          <div class="clip-range-controls">
            <div class="range-control-group">
              <label for="depth2DClipRange">表示奥行き範囲:</label>
              <div class="range-slider-container">
                <span class="range-label">狭い</span>
                <input type="range"
                  id="depth2DClipRange"
                  min="1000"
                  max="20000"
                  value="5000"
                  step="500"
                  class="clip-range-slider"
                >
                <span class="range-label">広い</span>
              </div>
              <div class="range-value-display">
                ±<span id="depth2DRangeValue">5.0</span>m
              </div>
            </div>

            <div class="range-control-group mt-2">
              <label for="depth2DClipCenter">奥行き中心位置:</label>
              <div class="range-slider-container">
                <span class="range-label short">下</span>
                <input type="range"
                  id="depth2DClipCenter"
                  min="-50000"
                  max="50000"
                  value="0"
                  step="500"
                  class="clip-range-slider"
                >
                <span class="range-label short">上</span>
              </div>
              <div class="range-value-display">
                <span id="depth2DCenterValue">0.0</span>m
              </div>
            </div>

            <button
              id="applyDepth2DClipButton"
              class="clip-apply-btn w-100 mt-2"
             type="button">
              2D奥行きクリップを適用
            </button>
          </div>
        </div>

        <hr class="section-divider" >

        <!-- クリッピング制御ボタン -->
        <div class="clipping-controls">
          <button id="clearClipButton" class="clear-clip-btn" type="button">
            クリッピング解除
          </button>
          <button id="previewClipButton" class="preview-clip-btn hidden" type="button">
            プレビュー表示
          </button>
        </div>
      </div>
    </div>

    <!-- 表示モード設定フローティングウィンドウ -->
    <div id="camera-settings-float" class="floating-window">
      <div class="float-window-header" id="camera-settings-header">
        <span class="float-window-title">🔄 表示モード設定</span>
        <div class="float-window-controls">
          <button class="float-window-btn" id="close-camera-settings-btn" aria-label="閉じる" type="button">
            ✕
          </button>
        </div>
      </div>
      <div class="float-window-content">
        <!-- 表示モード切り替え -->
        <label><strong>表示モード</strong></label>
        <div class="camera-mode-container">
          <button
            type="button"
            class="btn btn-sm camera-mode-btn active"
            data-mode="perspective"
            id="cameraPerspectiveBtn"
          >
            🏠 立体表示
          </button>
          <button
            type="button"
            class="btn btn-sm camera-mode-btn"
            data-mode="orthographic"
            id="cameraOrthographicBtn"
          >
            📄 図面表示
          </button>
        </div>
        <!-- Hidden radio buttons for compatibility -->
        <input type="radio"
          name="cameraMode"
          value="perspective"
          id="cameraPerspective"
          checked
          class="sr-only"
        >
        <label class="sr-only" for="cameraPerspective">立体表示</label>
        <input type="radio"
          name="cameraMode"
          value="orthographic"
          id="cameraOrthographic"
          class="sr-only"
        >
        <label class="sr-only" for="cameraOrthographic">図面表示</label>

        <!-- ビュー方向選択（2Dモード時のみ表示） -->
        <div id="viewDirectionPanel" class="hidden">
          <hr class="section-divider">
          <label><strong>ビュー方向</strong></label>
          <div class="view-direction-buttons">
            <button type="button" class="btn btn-sm" data-view="top">
              平面図
            </button>
            <button type="button" class="btn btn-sm" data-view="front">
              正面図
            </button>
            <button type="button" class="btn btn-sm" data-view="right">
              右側面図
            </button>
            <button type="button" class="btn btn-sm" data-view="left">
              左側面図
            </button>
            <button type="button" class="btn btn-sm" data-view="iso">
              等角図
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- ツリーウィンドウ（要素ツリー、断面ツリー）はJSで動的に生成されます -->
  </body>
</html>
